name: Analyze Submissions

on:
  workflow_dispatch:
    inputs:
      course:
        description: 'Course to analyze'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - cst349
          - cst395
      action:
        description: 'Action to perform'
        required: true
        default: 'full'
        type: choice
        options:
          - full              # Download + Analyze + Dashboard
          - download          # Download submissions from Canvas
          - analyze           # Analyze with LLM
          - dashboard         # Generate dashboard only
          - post-grades       # Post reviewed grades to Canvas
      assignment:
        description: 'Single assignment key to analyze (optional, blank = all)'
        required: false
        default: ''
        type: string

concurrency:
  group: analyze-${{ github.ref }}-${{ inputs.course }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4

      - name: Clone private data repo
        env:
          DATA_REPO_PAT: ${{ secrets.DATA_REPO_PAT }}
        run: |
          git clone "https://x-access-token:${DATA_REPO_PAT}@github.com/profsathya/Common-Curriculum-Data.git" data-repo 2>&1 || true
          if [ ! -d "data-repo/.git" ]; then
            echo "Empty repo — initializing..."
            mkdir -p data-repo
            cd data-repo
            git init
            git remote add origin "https://x-access-token:${DATA_REPO_PAT}@github.com/profsathya/Common-Curriculum-Data.git"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Submission Analyzer
        env:
          CANVAS_API_TOKEN: ${{ secrets.CANVAS_API_TOKEN }}
          CANVAS_BASE_URL: ${{ secrets.CANVAS_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          INPUT_ACTION: ${{ inputs.action }}
          INPUT_COURSE: ${{ inputs.course }}
          INPUT_ASSIGNMENT: ${{ inputs.assignment }}
        run: |
          echo "=============================================="
          echo "Submission Analyzer: ${INPUT_ACTION}"
          echo "Course: ${INPUT_COURSE}"
          echo "Assignment: ${INPUT_ASSIGNMENT:-all}"
          echo "=============================================="

          ARGS="--action=${INPUT_ACTION} --course=${INPUT_COURSE} --data-dir=./data-repo"

          if [ -n "${INPUT_ASSIGNMENT}" ]; then
            ARGS="$ARGS --assignment=${INPUT_ASSIGNMENT}"
          fi

          node scripts/submission-analyzer.js $ARGS

      - name: Push results to data repo
        env:
          INPUT_ACTION: ${{ inputs.action }}
          INPUT_COURSE: ${{ inputs.course }}
        working-directory: data-repo
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          # Check for changes
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "Update: ${INPUT_ACTION} for ${INPUT_COURSE} [$(date -u +%Y-%m-%dT%H:%M:%SZ)]"

            # Handle first push to empty repo
            if git rev-parse --verify origin/main >/dev/null 2>&1; then
              git push
            else
              git branch -M main
              git push -u origin main
            fi
            echo "✓ Results pushed to data repo"
          else
            echo "No changes to push"
          fi

      - name: Summary
        env:
          INPUT_ACTION: ${{ inputs.action }}
          INPUT_COURSE: ${{ inputs.course }}
        run: |
          echo "=============================================="
          echo "COMPLETE"
          echo "=============================================="
          echo "Action: ${INPUT_ACTION}"
          echo "Course: ${INPUT_COURSE}"
          echo ""
          echo "View results: https://github.com/profsathya/Common-Curriculum-Data"
          echo ""
          echo "To view the dashboard locally:"
          echo "  git clone https://github.com/profsathya/Common-Curriculum-Data"
          echo "  open Common-Curriculum-Data/dashboard/cst349-dashboard.html"
